<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Session 1.2: Collecting, reading and cleaning text data</title>

<script src="site_libs/header-attrs-2.15/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Overview
  </a>
</li>
<li>
  <a href="pensum.html">
    <span class="fa fa-list-ul"></span>
     
    Reading List
  </a>
</li>
<li>
  <a href="schedule.html">
    <span class="fa fa-info"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Quantitative methods
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Day 1</li>
    <li>
      <a href="1_1-DescStat.html">Descriptive statistics</a>
    </li>
    <li class="dropdown-header">Day 2</li>
    <li>
      <a href="2_1-CorrAnalysis.html">Correlation analysis</a>
    </li>
    <li class="dropdown-header">Day 3</li>
    <li>
      <a href="3_1-RegAnalysis.html">Regression analysis</a>
    </li>
    <li class="dropdown-header">Day 4</li>
    <li>
      <a href="4_1-Uncertainty.html">Uncertainty</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Computational text analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Day 1</li>
    <li>
      <a href="1_2-readingcleaning.html">Reading and cleaning text data</a>
    </li>
    <li class="dropdown-header">Day 2</li>
    <li>
      <a href="2_2-WordFreq.html">Word frequency and dictionary methods</a>
    </li>
    <li class="dropdown-header">Day 3</li>
    <li>
      <a href="3_2-Topicmodelling.html">Topic modelling</a>
    </li>
    <li class="dropdown-header">Day 4</li>
    <li>
      <a href="4_2-WordEmbedding.html">Word embedding</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Session 1.2: Collecting, reading and
cleaning text data</h1>

</div>


<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<p>We’ll need the following libraries for this session</p>
<pre class="r"><code>library(readtext)
library(tidyverse)
library(tabulizer)</code></pre>
<p>The Charles Dickens novels can be downloaded <a
href="data/docs/A%20Christmas%20Carol%20-%20Charles%20Dickens%20-%201843.pdf">here</a>,
<a
href="data/docs/David%20Copperfield%20-%20Charles%20Dickens%20-%201850.txt">here</a>,
<a
href="data/docs/Hard%20Times%20-%20Charles%20Dickens%20-%201854.docx">here</a>,
and <a
href="data/docs/Oliver%20Twist%20-%20Charles%20Dickens%20-%201838.html">here</a>.</p>
<div id="reading-in-documents" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Reading in
Documents</h1>
<p>We’d be nowhere without documents! And getting them into R is no
trivial task. The first question to ask is, what is the format of the
documents I want to read into R?</p>
<div id="reading-in-txt-doc-or-pdf-files" class="section level2"
number="1.1">
<h2><span class="header-section-number">1.1</span> Reading in txt, doc
or pdf files</h2>
<p>Historians are interested in old books and there are a lot of old
books freely accessible on the web already digitized (and some of them
even cleaned). For an example, I’ve gone to <a
href="https://www.gutenberg.org/">Project Gutenberg</a> and downloaded
four Charles Dickens novels. To demonstrate a point, I have saved them
in four different formats: Word, pdf, txt, html and saved them (links
just above) with the file names “[Novel_name] - [Author] - [Year]”.</p>
<p>Now let’s take a look at what is in that folder. I’ve also saved some
files as Word and PDF files.</p>
<pre class="r"><code>(books_list &lt;- list.files(path = &quot;data/docs&quot;, full.names = TRUE))</code></pre>
<pre><code>## [1] &quot;data/docs/A Christmas Carol - Charles Dickens - 1843.pdf&quot;
## [2] &quot;data/docs/David Copperfield - Charles Dickens - 1850.txt&quot;
## [3] &quot;data/docs/Hard Times - Charles Dickens - 1854.docx&quot;      
## [4] &quot;data/docs/Oliver Twist - Charles Dickens - 1838.html&quot;</code></pre>
<p><code>readtext</code> is a handy R package that will automatically
decide what sort of file it is, read it in, AND will help us out with
variables associated with the document.</p>
<pre class="r"><code>books &lt;- readtext(books_list)
# Notice this will save as a readtext object. Let&#39;s convert to our tidyverse&#39;s format for dataframes, called a tibble.
books &lt;- as_tibble(books)</code></pre>
<p>Notice that it has read these texts into R and we now have them all
in a dataframe - one column is a <code>doc_id</code> and the other is
the text. There is no metadata (document variables).
<code>readtext</code> allows us to import variables automatically from
file names (assuming we have informative file names, which, as it
<em>just so happens</em>, we do). As an aside, we could do similar
things with the help of the tidyverse and a function called <a
href="https://tidyr.tidyverse.org/reference/separate.html"><code>separate</code></a>,
but we’ll just use <code>readtext</code> here.</p>
<pre class="r"><code>books &lt;- readtext(books_list, docvarsfrom=&quot;filenames&quot;, dvsep = &#39; - &#39;, docvarnames = c(&#39;Title&#39;, &#39;Author&#39;, &#39;Year&#39;)) %&gt;%
  as_tibble()
books</code></pre>
<pre><code>## # A tibble: 4 × 5
##   doc_id                                         text         Title Author  Year
##   &lt;chr&gt;                                          &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;
## 1 A Christmas Carol - Charles Dickens - 1843.pdf &quot;^, A&lt;r   C… A Ch… Charl…  1843
## 2 David Copperfield - Charles Dickens - 1850.txt &quot;The Projec… Davi… Charl…  1850
## 3 Hard Times - Charles Dickens - 1854.docx       &quot;The Projec… Hard… Charl…  1854
## 4 Oliver Twist - Charles Dickens - 1838.html     &quot;The Projec… Oliv… Charl…  1838</code></pre>
<p>And we now can save this to a file for easy access next time we work
on it. There are multiple ways to do this, one is to save as a csv
file.</p>
<pre class="r"><code>write_csv(books, &quot;data/dickens_books.csv&quot;)</code></pre>
<p>It might be worthwhile mentioning that there is an R <a
href="https://cran.r-project.org/web/packages/gutenbergr/vignettes/intro.html">package</a>
for accessing Project Gutenberg that you would actually want to use that
would be easier than downloading things by hand.</p>
</div>
<div id="pdfs-that-use-columns-or-other-different-text-layouts"
class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> PDFs that use columns
or other different text layouts</h2>
<p><code>readtext</code> and a similar R package called
<code>pdftools</code> are great but they get flummoxed by weird text
layouts, including kinds you find quite often in official state
documents.</p>
<div class="figure" style="text-align: center">
<img src="data/stortExample.jpg" alt="Sample page of Storting proceedings. Bundestag proceedings, and doubtlessly many more, are formatted the same way." width="395" />
<p class="caption">
Sample page of Storting proceedings. Bundestag proceedings, and
doubtlessly many more, are formatted the same way.
</p>
</div>
<p><code>readtext</code> is going to have a hard time with that. You can
try it yourself but it’s going to read from left to right across
columns, rather than the left column first then the right.</p>
<p>As of a couple of years ago one had to get really creative and cut
the pdfs up and then sew them back together (there might still be times
when you want to do this, see the <a
href="https://docs.ropensci.org/magick/articles/intro.html"><code>magick</code></a>
package) but now we have an R package that is quite smart about this
called <code>tabulizer</code>. The package has java dependencies that
might create huge problems in Windows. Another option is to use
Rstudio’s quite cool cloud service at <a href="https://rstudio.cloud"
class="uri">https://rstudio.cloud</a>. We can upload documents there,
install the packages we need on then download the resulting dataframe we
build there.</p>
<p>Let’s take a historical <a href="data/stmeld8_kongo.pdf">Storting
melding</a>. The front page looks like this.</p>
<div class="figure" style="text-align: center">
<img src="data/st_meld.jpg" alt="Clear machine-readable text but in columns." width="395" />
<p class="caption">
Clear machine-readable text but in columns.
</p>
</div>
<p>Hmm, multi-column format. First we might try <code>readtext</code>
and print out the first 1000 characters to see how things look. Save the
pdf somewhere you’ll know where to access it (I’ve saved midne in the
“data” folder in my working drive).</p>
<pre class="r"><code>df&lt;- readtext(&#39;data/stmeld8_kongo.pdf&#39;)
str_sub(df$text, 1, 1000) # if we print out in cat() we see that the spacing is preserved from the original pdf</code></pre>
<pre><code>## [1] &quot;                                                                       Utenriksdepartementet\n\n\n\n\n                                 St. meld. nr. 8.\n                                      (1960-61)\n             Melding om Norges deltaking i De Forente Nasjoners\n                            vaktstyrke i Kongo.\n                  Tilråding fra Utenriksdepartementet av 23. september 1960,\n                          godkjent ved kongelig resolusjon samme dag.\n\n                     (Foredratt av utenriksminister Halvard Lange.)\n\n    Den 30. juni 1960 ble tidligere Belgisk Kongo     Samtidig med dette brøt Katanga-provinsen\nproklamert som selvstendig stat.                    seg løs og proklamerte seg som selvstendig\n    Avtalen om at området som hadde vært            stat.\nunder belgisk overhøyhet siden 1885, skulle\nbli uavhengig, var inngått i Brussel i januar          Mot denne bakgrunn sendte den kongole\n1960 mellom den belgiske regjering og poli          siske regjering den 12. juli en telegr&quot;</code></pre>
<p>It looks like we’ve read in a bunch of text, and we have. But if we
look a bit closer, we see that the first sentence of the document in the
pdf reads: “Den 30. juni 1960 ble tidligere Belgisk Kongo proklamert som
selvstendig stat.” But <code>readtext</code> ignores the column space
and has: “Den 30. juni 1960 ble tidligere Belgisk Kongo Samtidig med
dette brøt Katanga-provinsen\nproklamert som selvstendig stat.” And we
see the whitespace that is actually the column break. There are actually
methods we’re going to use that will throw out word order and this sort
of thing wouldn’t matter. But not always by any means.</p>
<p>The tabulizer package is just as easy. Tabulizer can be problematic
to install because of Java dependencies but run either from your own PC
or from the RStudio cloud, it gives a much better result for no extra
work.</p>
<pre class="r"><code>file &lt;- &#39;data/stmeld8_kongo.pdf&#39;
numpages &lt;- get_n_pages(file) 
text &lt;- extract_text(file, encoding = &#39;UTF-8&#39;, pages=1:numpages) # this will return a vector of one character string per page. Take the pages option out of the call and we get one collapsed character string for the whole document. </code></pre>
<p>Finally, tabulizer is an incredibly powerful package. If you have
tables you’d like to read from pdfs, as economic historians very well
might, I highly recommend tabulizer’s very cool
<code>extract_areas()</code> function. Say we have a page like below and
we’d like to extract just the table from Statoil’s 2001 <a
href="https://www.equinor.com/sustainability/sustainability-reports-archive">Sustainability
Report</a> (<a href="data/sustainability-report-2001-equinor.pdf">direct
link</a>).</p>
<div class="figure" style="text-align: center">
<img src="data/statoilSRExample.jpg" alt="Page 44 of Statoil's 2001 Sustainability Report." width="214" />
<p class="caption">
Page 44 of Statoil’s 2001 Sustainability Report.
</p>
</div>
<p>We can do this interactively with tabulizer. We can call
<code>extract_areas()</code> and then highlight the part of the page
where the table is located telling tabulizer where to extract the table
data from.</p>
<pre class="r"><code>extract_areas(&quot;data/sustainability-report-2001-equinor.pdf&quot;, 44)</code></pre>
<p>If you have numerous documents with tables at the same place you can
also specify location to have <code>tabulizer</code> do this over
numerous documents. Powerful stuff.</p>
</div>
<div
id="reading-in-non-machine-readable-pdfs-hardest-and-probably-most-likely-for-historians"
class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Reading in
non-machine readable PDFs (hardest and probably most likely for
historians)</h2>
<p>Perhaps the documents we historians are most likely to want to
analyze are hand-scanned archival documents. These we might have as
pictures (jgp or gif or tiff formats perhaps) or pdf files on our local
machine. To make these digitally analyzable we’ll need to use optical
character recognition (OCR) technology. This is a rapidly progressing
frontier of machine learning and the technology is constantly getting
better. Humans are still far better at reading and recognizing text than
computers but the gap is steadily shrinking and might one day in the
future disappear. For now though, we’ll have to deal with less than
perfection.</p>
<p>R has “bindings” (packages that give access to) tessaract, which is
an open source Google OCR project. Below is an example using pdftools to
do this from .pdf (see the Tessaract <a
href="vignette">https://cran.r-project.org/web/packages/tesseract/vignettes/intro.html</a>
for an example of how to do this for .jpg files using the R package
<code>magick</code>.)</p>
<p>The way OCR works is that the algorithms are made to “learn” by
ingesting a large amount of data for which the right answers are known
(ie. images of text that have been, perfectly, digitized). The
algorithms trained to recognize English are included in the package,
anything else has to be downloaded by hand as shown below (to find you
needed language’s three letter code, see the <a
href="tessdata">https://github.com/tesseract-ocr/tessdata</a> github
repository and especially the list of available languages <a
href="here">https://tesseract-ocr.github.io/tessdoc/Data-Files-in-different-versions.html</a>).</p>
<p>Here is an example from my archive photos, a document form the
Norwegian Riksarkivet in Oslo.</p>
<p><img src="data/doc_norsk.jpg" width="50%" /></p>
<p>Tesseract takes in a file in an image format so if we have a PDF
we’ll need to convert it to an image format (well use .png here) first.
We’ll use the package <code>pdftools</code> to do this. Let’s first find
a document to practice on. All the defaults in Tesseract are English so
this is generally fairly straightforward. Other languages are more
challenging so we’ll do a Norwegian example.</p>
<p>We’ll take the King’s opening speech to the Stortinget in 1925. If we
got to historical documents on the Stortinget’s <a
href="webpage">https://www.stortinget.no/no/Saker-og-publikasjoner/Stortingsforhandlinger/#historiske-dokumenter</a>,
go to “Publikasjonstitler”, 1925 and search for “Hans Majestet Kongens
tale til det 74de ordentlige Storting ved dets åpning” (or just “hans
majastet” will probably work to). Download the speech, preferably with a
helpful title such as “Storting_KongHaakon_1925.pdf” or something of the
sort.</p>
<pre class="r"><code>norsk &lt;- tesseract(language=&#39;nor&#39;) #before doing this you will need to have run: tesseract_download(&#39;nor&#39;)
png_archivedoc &lt;- pdftools::pdf_convert(&quot;./data/Storting_KongHaakon_1925.pdf&quot;, dpi = 600)
text &lt;- ocr(png_archivedoc, engine=norsk)</code></pre>
<p>First, it needs to be cleaned up, which we’ll be turning to
momentarily. Even cleaned it’s not perfect. But not half bad.</p>
</div>
</div>
<div id="cleaning-up-text" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Cleaning up text</h1>
<p>As we’ve seen already, almost always when documents in the real world
are read into R they are highly imperfect. They will have all kinds of
crazy tags, whitespaces (which also show up as tags under some viewing
methods), and other things we may want to strip. In fact, in the real
world collecting and cleaning data generally takes at least as long as
analysis. A fairly balanced workshop on text analysis would probably
rightly spend at least half of its time on these issues and less on
analytics. We’ll get on to analytics in the next section but it’s
important to realize that these initial ones are just as important, even
if they seem a little dull and uninspiring.</p>
<p>We’ll use two sample corpora as examples and test corpora for the
rest of the workshop. The first is Nobel Peace Prize award ceremony
speeches since 1905. They are scraped from <a
href="https://www.nobelprize.org"
class="uri">https://www.nobelprize.org</a> using a slightly more
advanced methods than we’ll discuss here. For code and brief discussion,
see the <a href="#Appendix">Appendix</a>. The second is a corpus of
Sustainability Reports for several major international oil
companies.</p>
<p>The nobel corpus saved as csv is <a
href="data/NobelPeace.csv">here</a> and the oil company sustainability
reports <a href="data/srps.csv">here</a>. First let’s read them into
R.</p>
<pre class="r"><code>nobel &lt;- read_csv(&quot;data/NobelPeace.csv&quot;, locale=locale(encoding = &quot;latin1&quot;)) %&gt;%
  select(!...1)
sr &lt;- read_csv(&quot;data/srps.csv&quot;)</code></pre>
<div id="viewing-your-tibble-corpus" class="section level2"
number="2.1">
<h2><span class="header-section-number">2.1</span> Viewing your tibble
corpus</h2>
<p>So after the first two sessions we’re assuming we have our corpus in
a tibble, with one column being the text of the documents and other
columns of metadata – year and company for the Social Responsibility
reports, laureate and year for our Nobel Peace Prize award speeches.
First things first, there are numerous ways to try to get an overview of
the data. If you just enter the dataframe’s name in R you will get the
first few lines. Alternately, you can use <code>print()</code> – tibbles
are <a
href="https://tibble.tidyverse.org/reference/formatting.html">built</a>
to make printing and viewing dataframes easier. If we want to print all
rows (you have to be careful with this, if you have millions of rows
this will probably crash R) we can do this.</p>
<pre class="r"><code>nobel # note that this tells you the datatype of each column</code></pre>
<pre><code>## # A tibble: 92 × 3
##     Year Laureate                                                 AwardSpeech   
##    &lt;dbl&gt; &lt;chr&gt;                                                    &lt;chr&gt;         
##  1  1905 Bertha von Suttner                                       &quot;  On behalf …
##  2  1906 Theodore Roosevelt                                       &quot;As the Nobel…
##  3  1907 Ernesto Teodoro Moneta, Louis Renault                    &quot;Ernesto Teod…
##  4  1908 Klas Pontus Arnoldson, Fredrik Bajer                     &quot;On behalf of…
##  5  1909 Auguste Beernaert, Paul Henri d&#39;Estournelles de Constant &quot;Auguste Beer…
##  6  1910 Permanent International Peace Bureau                     &quot;Chairman of …
##  7  1911 Tobias Asser, Alfred Fried                               &quot;Tobias Micha…
##  8  1912 Elihu Root                                               &quot;Elihu Root w…
##  9  1913 Henri La Fontaine                                        &quot;Henri La Fon…
## 10  1922 Fridtjof Nansen                                          &quot;I take pleas…
## # … with 82 more rows
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<pre class="r"><code>print(nobel, n = Inf)</code></pre>
<pre><code>## # A tibble: 92 × 3
##     Year Laureate                                                        Award…¹
##    &lt;dbl&gt; &lt;chr&gt;                                                           &lt;chr&gt;  
##  1  1905 Bertha von Suttner                                              &quot;  On …
##  2  1906 Theodore Roosevelt                                              &quot;As th…
##  3  1907 Ernesto Teodoro Moneta, Louis Renault                           &quot;Ernes…
##  4  1908 Klas Pontus Arnoldson, Fredrik Bajer                            &quot;On be…
##  5  1909 Auguste Beernaert, Paul Henri d&#39;Estournelles de Constant        &quot;Augus…
##  6  1910 Permanent International Peace Bureau                            &quot;Chair…
##  7  1911 Tobias Asser, Alfred Fried                                      &quot;Tobia…
##  8  1912 Elihu Root                                                      &quot;Elihu…
##  9  1913 Henri La Fontaine                                               &quot;Henri…
## 10  1922 Fridtjof Nansen                                                 &quot;I tak…
## 11  1925 Sir Austen Chamberlain, Charles G. Dawes                        &quot;We st…
## 12  1926 Aristide Briand, Gustav Stresemann                              &quot;We st…
## 13  1927 Ferdinand Buisson, Ludwig Quidde                                &quot;The N…
## 14  1929 Frank B. Kellogg                                                &quot;  It …
## 15  1930 Nathan Söderblom                                                &quot;  It …
## 16  1931 Jane Addams, Nicholas Murray Butler                             &quot;In aw…
## 17  1933 Sir Norman Angell                                               &quot;In th…
## 18  1934 Arthur Henderson                                                &quot;It is…
## 19  1935 Carl von Ossietzky                                              &quot;Carl …
## 20  1936 Carlos Saavedra Lamas                                           &quot;The N…
## 21  1937 Robert Cecil                                                    &quot;Three…
## 22  1938 Nansen International Office for Refugees                        &quot;This …
## 23  1944 International Committee of the Red Cross                        &quot;  Six…
## 24  1945 Cordell Hull                                                    &quot;Corde…
## 25  1946 Emily Greene Balch, John R. Mott                                &quot;The e…
## 26  1947 Friends Service Council, American Friends Service Committee     &quot;  The…
## 27  1949 Lord Boyd Orr                                                   &quot;Lord …
## 28  1950 Ralph Bunche                                                    &quot;  Dr.…
## 29  1951 Léon Jouhaux                                                    &quot;Alfre…
## 30  1952 Albert Schweitzer                                               &quot;Alber…
## 31  1953 George C. Marshall                                              &quot;When …
## 32  1954 Office of the United Nations High Commissioner for Refugees     &quot;  The…
## 33  1957 Lester Bowles Pearson                                           &quot;The N…
## 34  1958 Georges Pire                                                    &quot;  The…
## 35  1959 Philip Noel-Baker                                               &quot;Frequ…
## 36  1960 Albert Lutuli                                                   &quot;  Thi…
## 37  1961 Dag Hammarskjöld                                                &quot;The N…
## 38  1962 Linus Pauling                                                   &quot;Short…
## 39  1963 International Committee of the Red Cross, League of Red Cross … &quot;The N…
## 40  1964 Martin Luther King Jr.                                          &quot;  Not…
## 41  1965 United Nations Children&#39;s Fund                                  &quot;The d…
## 42  1968 René Cassin                                                     &quot;The l…
## 43  1969 International Labour Organization                               &quot;When …
## 44  1970 Norman Borlaug                                                  &quot;In th…
## 45  1971 Willy Brandt                                                    &quot;  The…
## 46  1973 Henry Kissinger, Le Duc Tho                                     &quot;Your …
## 47  1974 Seán MacBride, Eisaku Sato                                      &quot;Your …
## 48  1975 Andrei Sakharov                                                 &quot;Trans…
## 49  1976 Betty Williams, Mairead Corrigan                                &quot;Trans…
## 50  1977 Amnesty International                                           &quot;Trans…
## 51  1978 Anwar al-Sadat, Menachem Begin                                  &quot;Trans…
## 52  1979 Mother Teresa                                                   &quot;Trans…
## 53  1980 Adolfo Pérez Esquivel                                           &quot;Trans…
## 54  1981 Office of the United Nations High Commissioner for Refugees     &quot;Your …
## 55  1982 Alva Myrdal, Alfonso García Robles                              &quot;Trans…
## 56  1983 Lech Walesa                                                     &quot;Your …
## 57  1984 Desmond Tutu                                                    &quot;Your …
## 58  1985 International Physicians for the Prevention of Nuclear War      &quot;Your …
## 59  1986 Elie Wiesel                                                     &quot;Your …
## 60  1987 Oscar Arias Sánchez                                             &quot;Your …
## 61  1988 United Nations Peacekeeping Forces                              &quot;Your …
## 62  1989 The 14th Dalai Lama                                             &quot;The N…
## 63  1990 Mikhail Gorbachev                                               &quot;Your …
## 64  1991 Aung San Suu Kyi                                                &quot;Your …
## 65  1992 Rigoberta Menchú Tum                                            &quot;Your …
## 66  1993 Nelson Mandela, F.W. de Klerk                                   &quot;Your …
## 67  1994 Yasser Arafat, Shimon Peres, Yitzhak Rabin                      &quot;Your …
## 68  1995 Joseph Rotblat, Pugwash Conferences on Science and World Affai… &quot;Your …
## 69  1996 Carlos Filipe Ximenes Belo, José Ramos-Horta                    &quot;Trans…
## 70  1997 International Campaign to Ban Landmines, Jody Williams          &quot;Trans…
## 71  1998 John Hume, David Trimble                                        &quot;Trans…
## 72  1999 Médecins Sans Frontières                                        &quot;Trans…
## 73  2000 Kim Dae-jung                                                    &quot;  Tra…
## 74  2001 United Nations, Kofi Annan                                      &quot;  Tra…
## 75  2002 Jimmy Carter                                                    &quot;Trans…
## 76  2003 Shirin Ebadi                                                    &quot;Trans…
## 77  2004 Wangari Maathai                                                 &quot;Engli…
## 78  2005 International Atomic Energy Agency, Mohamed ElBaradei           &quot;Your …
## 79  2006 Muhammad Yunus, Grameen Bank                                    &quot;Your …
## 80  2007 Intergovernmental Panel on Climate Change, Al Gore              &quot;Norwe…
## 81  2008 Martti Ahtisaari                                                &quot;Norwe…
## 82  2009 Barack H. Obama                                                 &quot;© THE…
## 83  2010 Liu Xiaobo                                                      &quot;Your …
## 84  2011 Ellen Johnson Sirleaf, Leymah Gbowee, Tawakkol Karman           &quot;Your …
## 85  2012 European Union (EU)                                             &quot;Your …
## 86  2013 Organisation for the Prohibition of Chemical Weapons            &quot;Your …
## 87  2014 Kailash Satyarthi, Malala Yousafzai                             &quot;Norwe…
## 88  2015 National Dialogue Quartet                                       &quot;Your …
## 89  2016 Juan Manuel Santos                                              &quot;Norwe…
## 90  2017 International Campaign to Abolish Nuclear Weapons (ICAN)        &quot;Norwe…
## 91  2018 Denis Mukwege, Nadia Murad                                      &quot;Norwe…
## 92  2019 Abiy Ahmed Ali                                                  &quot;Your …
## # … with abbreviated variable name ¹​AwardSpeech</code></pre>
<p>Other options are <code>glimpse()</code> (tidyverse) and
<code>str()</code> (baseR) that give you different ways to visualize a
bit. Often the easiest is to ask R to open a separate window with
<code>View()</code>. Finally, sometimes if you have a long character
string the easiest way to inspect it is simply to print it out
separately. Using the <code>cat()</code> command will format using the
formatting tags in the text – it will look nicer but you might want to
know where the /n and /t tags (newline and tab markers) are.</p>
<pre class="r"><code>#View(nobel) # opens a new window
nobel$AwardSpeech[4] # will show the fourth line of the text column of the nobel dataframe</code></pre>
<pre><code>## [1] &quot;On behalf of the Nobel Committee of the Norwegian Parliament, I have the honor to extend a welcome to all who have assembled here on this occasion commemorating the great Swedish patron and benefactor, Alfred Nobel, who gave the whole of his large fortune to the solution of problems concerning the future fate of mankind. Since we last met here, one of the winners of the Peace Prize, Randal Cremer, has left us forever1; but he has left behind the memory of a great personality and of a warm friend of peace and of mankind. I invite you all to honor his memory by standing. This year the Nobel Committee has unanimously decided to divide the Peace Prize between former member of the Swedish Parliament, K.P. Arnoldson, and former member of the Danish Parliament, Fredrik Bajer. It is a great pleasure for the Committee to award the prize to these gentlemen, since it is convinced that its choice accords with the general desire in the Scandinavian countries. They have both been untiring advocates of the ideals of peace. K.P. Arnoldson was born in Gothenburg in 1844 and in his youth was in the service of the Swedish Railways. At the same time, however, he also worked for the press as a journalist and author, one of his favorite subjects even then being the cause of peace. From 1882 to 1887 Arnoldson was a member of the Lower House of the Swedish Parliament; In 1883 he put forward a proposal for an address to the king, petitioning for a declaration of permanent neutrality by Sweden. The proposal was not adopted, but the House recommended that the government should continue to work along the lines of the proposal. In the same year Arnoldson helped to found the Swedish Peace and Arbitration Association [Svenska freds-och skiljedomsföreningen], which recently celebrated its twenty-fifth anniversary. Arnoldson was secretary of the association for the first few years and edited its paper. Arnoldson\u0092s work also extended to Norway. The success of his speeches in several of our cities in 1889 and 1890 indirectly encouraged Parliament in 1890 to adopt his arbitration address to the king. Arnoldson has published a number of important works on peace, several of which have been translated into other languages. His most important is The Hope of the Centuries: A Book on World Peace, an account of the growth of the idea of peace among nations and in international relations. Mr. Arnoldson, along with Mr. Fredrik Bajer, was nominated for the Nobel Peace Prize this year with the unanimous support of the Swedish Interparliamentary Group and a number of Norwegian members of Parliament.      *  *  * Fredrik Bajer was born in 1837. Like Tolstoy and many other fighters for peace, he began his career as an officer and from 1856 to 1865 was a lieutenant of Dragoons. He then began his study of foreign languages, becoming an elementary school teacher and later a translator. Already in the 1860\u0092s he was maintaining contact with the peace movement and was in touch with Frédéric Passy, who in 1867 founded the first French peace society1. From 1872 to 1895, Bajer was a member of Parliament for Horsens and during that time did much work for the cause of peace and for women\u0092s rights. Mr. Bajer has been an extraordinarily prolific writer, and in his many articles and pamphlets about and in favor of the cause of peace, he has dealt with practically all the problems involved in the peace movement. Norwegian newspapers have also enjoyed the benefit of his able pen. Special mention should be made of his great study of the question of neutrality. In 1882 he was also responsible for the foundation of a peace society in Denmark, at first called the Society for the Promotion of Danish Neutrality and later the Danish Peace Society2. At a very early date Mr. Bajer took an active part in the European peace movement. In 1884 he participated in the International Congress in Bern and in 1889 he took part both in the International Congress and in the Interparliamentary Conference, held during the Great Exhibition in Paris; since then there have been few of these meetings in which he has not participated. It was at his instigation and suggestion that in 1891 a permanent International Peace Bureau was established in Bern. Bajer was president of its Board of Administration until last year when he declined reelection and was instead named honorary president. Since 1891 Bajer has also had a seat on the council which controls the Interparliamentary Union. He has always shown a great interest in cooperation between the Nordic countries in the cause of peace. He has invariably taken part in the Nordic peace meetings, and it is mainly due to his efforts that a Nordic Interparliamentary Union has been founded3. Fredrik Bajer was nominated this year as a candidate for the Nobel Peace Prize by the Danish Interparliamentary Group, among others, and, together with K.P. Arnoldson, by the Swedish Interparliamentary Group and a number of members of the Norwegian Parliament.&quot;</code></pre>
<pre class="r"><code>cat(nobel$AwardSpeech[4]) # nicer formatting but now you&#39;re not seeing formatting tags in the text</code></pre>
<pre><code>## On behalf of the Nobel Committee of the Norwegian Parliament, I have the honor to extend a welcome to all who have assembled here on this occasion commemorating the great Swedish patron and benefactor, Alfred Nobel, who gave the whole of his large fortune to the solution of problems concerning the future fate of mankind. Since we last met here, one of the winners of the Peace Prize, Randal Cremer, has left us forever1; but he has left behind the memory of a great personality and of a warm friend of peace and of mankind. I invite you all to honor his memory by standing. This year the Nobel Committee has unanimously decided to divide the Peace Prize between former member of the Swedish Parliament, K.P. Arnoldson, and former member of the Danish Parliament, Fredrik Bajer. It is a great pleasure for the Committee to award the prize to these gentlemen, since it is convinced that its choice accords with the general desire in the Scandinavian countries. They have both been untiring advocates of the ideals of peace. K.P. Arnoldson was born in Gothenburg in 1844 and in his youth was in the service of the Swedish Railways. At the same time, however, he also worked for the press as a journalist and author, one of his favorite subjects even then being the cause of peace. From 1882 to 1887 Arnoldson was a member of the Lower House of the Swedish Parliament; In 1883 he put forward a proposal for an address to the king, petitioning for a declaration of permanent neutrality by Sweden. The proposal was not adopted, but the House recommended that the government should continue to work along the lines of the proposal. In the same year Arnoldson helped to found the Swedish Peace and Arbitration Association [Svenska freds-och skiljedomsföreningen], which recently celebrated its twenty-fifth anniversary. Arnoldson was secretary of the association for the first few years and edited its paper. Arnoldsons work also extended to Norway. The success of his speeches in several of our cities in 1889 and 1890 indirectly encouraged Parliament in 1890 to adopt his arbitration address to the king. Arnoldson has published a number of important works on peace, several of which have been translated into other languages. His most important is The Hope of the Centuries: A Book on World Peace, an account of the growth of the idea of peace among nations and in international relations. Mr. Arnoldson, along with Mr. Fredrik Bajer, was nominated for the Nobel Peace Prize this year with the unanimous support of the Swedish Interparliamentary Group and a number of Norwegian members of Parliament.      *  *  * Fredrik Bajer was born in 1837. Like Tolstoy and many other fighters for peace, he began his career as an officer and from 1856 to 1865 was a lieutenant of Dragoons. He then began his study of foreign languages, becoming an elementary school teacher and later a translator. Already in the 1860s he was maintaining contact with the peace movement and was in touch with Frédéric Passy, who in 1867 founded the first French peace society1. From 1872 to 1895, Bajer was a member of Parliament for Horsens and during that time did much work for the cause of peace and for womens rights. Mr. Bajer has been an extraordinarily prolific writer, and in his many articles and pamphlets about and in favor of the cause of peace, he has dealt with practically all the problems involved in the peace movement. Norwegian newspapers have also enjoyed the benefit of his able pen. Special mention should be made of his great study of the question of neutrality. In 1882 he was also responsible for the foundation of a peace society in Denmark, at first called the Society for the Promotion of Danish Neutrality and later the Danish Peace Society2. At a very early date Mr. Bajer took an active part in the European peace movement. In 1884 he participated in the International Congress in Bern and in 1889 he took part both in the International Congress and in the Interparliamentary Conference, held during the Great Exhibition in Paris; since then there have been few of these meetings in which he has not participated. It was at his instigation and suggestion that in 1891 a permanent International Peace Bureau was established in Bern. Bajer was president of its Board of Administration until last year when he declined reelection and was instead named honorary president. Since 1891 Bajer has also had a seat on the council which controls the Interparliamentary Union. He has always shown a great interest in cooperation between the Nordic countries in the cause of peace. He has invariably taken part in the Nordic peace meetings, and it is mainly due to his efforts that a Nordic Interparliamentary Union has been founded3. Fredrik Bajer was nominated this year as a candidate for the Nobel Peace Prize by the Danish Interparliamentary Group, among others, and, together with K.P. Arnoldson, by the Swedish Interparliamentary Group and a number of members of the Norwegian Parliament.</code></pre>
</div>
<div id="white-spaces-urls-tags-etc." class="section level2"
number="2.2">
<h2><span class="header-section-number">2.2</span> White spaces, urls,
tags, etc.</h2>
<p>As noted, we might well want to strip artefacts of the scanning and
importing process so we only have the text itself. Looking at our
<code>nobel$AwardSpeech[1]</code> call above we see some s, ’s, s. These
are <a href="https://en.wikipedia.org/wiki/Escape_character">escape
characters</a>. To see what they do:</p>
<pre class="r"><code>test &lt;- &quot;     Here \n there \t\t\t and \n\n\reverywhere.\n&quot;
print(test)</code></pre>
<pre><code>## [1] &quot;     Here \n there \t\t\t and \n\n\reverywhere.\n&quot;</code></pre>
<pre class="r"><code>cat(test)</code></pre>
<pre><code>##      Here 
##  there            and 
## 
## 
everywhere.</code></pre>
<p>There are also things like <code>\u0092</code> that are charcter
encodings that have gotten garbled – this one representing an
apostrophe. We also might want to look for where there is more than one
space and replace it with one, remove white space at the beginning… and
so on. We can use stringr’s <code>str_replace_all</code> to do all this
and utilize our knowledge of regular expressions (the stringr <a
href="https://stringr.tidyverse.org/">documentation</a> and cheatsheet
are especially helpful).</p>
<pre class="r"><code># Practice on our small test string
test &lt;- &quot;     Here \n there and \t\t\t everywhere.\n&quot;
test_clean &lt;- str_replace_all(test, &quot;[(\\n)(\\r)(\\t)]&quot;, &#39; &#39;)
test_clean &lt;- str_replace_all(test_clean, &quot; {2,}&quot;, &quot; &quot;)
test_clean &lt;- str_replace_all(test_clean, &quot;^ *| *$&quot;, &quot;&quot;)
test_clean</code></pre>
<pre><code>## [1] &quot;Here there and everywhere.&quot;</code></pre>
<p>That removed all those spacing encodings and whitespace. But it won’t
be any surprise to you anymore that the tidyverse actually makes this
much easier for us.</p>
<pre class="r"><code>str_squish(test) </code></pre>
<pre><code>## [1] &quot;Here there and everywhere.&quot;</code></pre>
<p>So that was simple. Now the unicode encodings from the Nobel
speaches.</p>
<pre class="r"><code>speech &lt;- nobel$AwardSpeech[1]
str_replace(speech, &quot;\u0092&quot;, &quot;&#39;&quot;)</code></pre>
<pre><code>## [1] &quot;  On behalf of the Nobel Committee, Bjørnstjerne Bjørnson introduced the speaker, Baroness Bertha von Suttner, to the audience. In a few words he recalled the great influence of the Baroness on the growth of the peace movement. While still young she had had the audacity to oppose the horrors of war1, and had done so in one of the most militaristic countries in Europe. She had continued this fight all her life and never wearied of crying \u0093Down with Arms\u00932. Despite the laughter with which her words had been greeted in the beginning, they did receive a hearing because they were uttered by a person of noble character and because they proclaimed humanity&#39;s greatest cause. Many women had since followed in her footsteps and taken up the cause, and the call to lay down arms had become general. Moreover, to all men of goodwill the cause of peace and the women\u0092s cause were one and the same movement, striving for the same goal. When the cause of peace prevailed, then too would the women\u0092s cause be won. * * * History constantly demonstrates the great influence of women. Women have encouraged the ideas of war, the attitude to life, and the causes for which men have fought, for which their sons were brought up, and of which they have dreamed. Any change or reformation of these ideas must be brought about chiefly by women. The human ideal of manly courage and manly deeds must become more enlightened; the faithful worker in all spiritual and material spheres of life must displace the bloodstained hero as the true ideal. Women will cooperate to give men higher aims, to give their sons nobler dreams. Many are the individual women who have set an example in sacrifice and work, who have followed the armies as angels of consolation and healing, tending the sick and suffering. How much more effective it is to do one\u0092s utmost to prevent misfortune! This is where you, Madame Baroness, have taken the lead among women of today. You have attacked war itself and cried to the nations: \u0093Down with arms!\u0094 This call will be your eternal honor. Beginning as a murmur in the corn on a summer\u0092s day\r\nAnd growing to a gale through the tops of the forest,\r\nTill the ocean bears it on with tenderous voice,\r\nAnd nothing is heard but this.1 These stirring words of our great poet apply to your call to action, Madame Baroness. It began as a murmur through the lovely meadow of the Danube Valley2 , that old highway for the devastating armies of war. We already hear it in the forests in all parts of the world and soon, we hope, its voice, borne by the oceans of people, will permanently drown the sound of war drums and trumpets. This will take a long time, some will say. We do not know. And it makes no difference to our work. Our task is clear: to combat any act of violence, any war of aggression, and so render even the justifiable defensive war unnecessary. We shall rouse the conscience of man, put justice and morality in the place of war. We thank you, Madame Baroness, for your firm faith, for your hope and self-sacrifice, for your work. We too, in the lands of the North, women as well as men, need you to light and nourish the flame of faith and work. Good luck to you! Frédèric Passy, that venerable apostle of peace3 has called you, Madame Baroness, our general-in-chief. The friends of peace in Scandinavia applaud this salute.&quot;</code></pre>
<!-- Well, that should have worked, but didn't. In fact, when we search for that escaped unicode character, regex is actually searching for the character itself, not the code. So we have to double escape it. Which is R means 3 backslashes. One final change that is usually made is to make all letters lowercase so as to make word searches easier. -->
<pre class="r"><code>speech %&gt;%
  str_replace_all(&quot;\u0092&quot;, &quot;&#39;&quot;) %&gt;%
  str_replace_all(&quot;(\u0093)|(\u0094)&quot;, &#39;&quot;&#39;) %&gt;%
  str_squish() %&gt;%
  str_to_lower() %&gt;% # make all letters lower case
  writeLines()</code></pre>
<pre><code>## on behalf of the nobel committee, bjørnstjerne bjørnson introduced the speaker, baroness bertha von suttner, to the audience. in a few words he recalled the great influence of the baroness on the growth of the peace movement. while still young she had had the audacity to oppose the horrors of war1, and had done so in one of the most militaristic countries in europe. she had continued this fight all her life and never wearied of crying &quot;down with arms&quot;2. despite the laughter with which her words had been greeted in the beginning, they did receive a hearing because they were uttered by a person of noble character and because they proclaimed humanity&#39;s greatest cause. many women had since followed in her footsteps and taken up the cause, and the call to lay down arms had become general. moreover, to all men of goodwill the cause of peace and the women&#39;s cause were one and the same movement, striving for the same goal. when the cause of peace prevailed, then too would the women&#39;s cause be won. * * * history constantly demonstrates the great influence of women. women have encouraged the ideas of war, the attitude to life, and the causes for which men have fought, for which their sons were brought up, and of which they have dreamed. any change or reformation of these ideas must be brought about chiefly by women. the human ideal of manly courage and manly deeds must become more enlightened; the faithful worker in all spiritual and material spheres of life must displace the bloodstained hero as the true ideal. women will cooperate to give men higher aims, to give their sons nobler dreams. many are the individual women who have set an example in sacrifice and work, who have followed the armies as angels of consolation and healing, tending the sick and suffering. how much more effective it is to do one&#39;s utmost to prevent misfortune! this is where you, madame baroness, have taken the lead among women of today. you have attacked war itself and cried to the nations: &quot;down with arms!&quot; this call will be your eternal honor. beginning as a murmur in the corn on a summer&#39;s day and growing to a gale through the tops of the forest, till the ocean bears it on with tenderous voice, and nothing is heard but this.1 these stirring words of our great poet apply to your call to action, madame baroness. it began as a murmur through the lovely meadow of the danube valley2 , that old highway for the devastating armies of war. we already hear it in the forests in all parts of the world and soon, we hope, its voice, borne by the oceans of people, will permanently drown the sound of war drums and trumpets. this will take a long time, some will say. we do not know. and it makes no difference to our work. our task is clear: to combat any act of violence, any war of aggression, and so render even the justifiable defensive war unnecessary. we shall rouse the conscience of man, put justice and morality in the place of war. we thank you, madame baroness, for your firm faith, for your hope and self-sacrifice, for your work. we too, in the lands of the north, women as well as men, need you to light and nourish the flame of faith and work. good luck to you! frédèric passy, that venerable apostle of peace3 has called you, madame baroness, our general-in-chief. the friends of peace in scandinavia applaud this salute.</code></pre>
<p>That looks pretty clean just as text. For most of our text analysis
we’re actually going to remove all punctuation, but there is an argument
to be made for getting as clean an original text as you can to start out
with. Now that we know how to use <code>stringr</code> and regular
expressions, we can easily strip out all punctuation. (some of the
packages we will be using will also do this automatically for us as
well)</p>
<p>Let’s do that to the whole nobel corpus. We can either write a loop
(seen as less good) or use the tidyverse (better).</p>
<pre class="r"><code># for (i in 1:dim(nobel)[1]){
#   nobel[&#39;AwardSpeech&#39;][i,] &lt;- nobel[&#39;AwardSpeech&#39;][i,] %&gt;%
#     str_replace_all(&quot;\u0092&quot;, &quot;&#39;&quot;) %&gt;%
#     str_replace_all(&quot;(\u0093)|(\u0094)&quot;, &#39;&quot;&#39;) %&gt;%
#     str_squish()
#}

#OR

(nobel &lt;- nobel %&gt;%
  mutate(clean_text = str_replace_all(AwardSpeech, &quot;\u0092&quot;, &quot;&#39;&quot;)) %&gt;%
  mutate(clean_text = str_replace_all(clean_text, &quot;(\u0093)|(\u0094)&quot;, &#39;&quot;&#39;)) %&gt;%
  mutate(clean_text = str_to_lower(clean_text)) %&gt;%
  mutate(clean_text = str_squish(clean_text)))</code></pre>
<pre><code>## # A tibble: 92 × 4
##     Year Laureate                                                Award…¹ clean…²
##    &lt;dbl&gt; &lt;chr&gt;                                                   &lt;chr&gt;   &lt;chr&gt;  
##  1  1905 Bertha von Suttner                                      &quot;  On … &quot;on be…
##  2  1906 Theodore Roosevelt                                      &quot;As th… &quot;as th…
##  3  1907 Ernesto Teodoro Moneta, Louis Renault                   &quot;Ernes… &quot;ernes…
##  4  1908 Klas Pontus Arnoldson, Fredrik Bajer                    &quot;On be… &quot;on be…
##  5  1909 Auguste Beernaert, Paul Henri d&#39;Estournelles de Consta… &quot;Augus… &quot;augus…
##  6  1910 Permanent International Peace Bureau                    &quot;Chair… &quot;chair…
##  7  1911 Tobias Asser, Alfred Fried                              &quot;Tobia… &quot;tobia…
##  8  1912 Elihu Root                                              &quot;Elihu… &quot;elihu…
##  9  1913 Henri La Fontaine                                       &quot;Henri… &quot;henri…
## 10  1922 Fridtjof Nansen                                         &quot;I tak… &quot;i tak…
## # … with 82 more rows, and abbreviated variable names ¹​AwardSpeech, ²​clean_text
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>We can compare AwardSpeech with text columns,
<code>nobel$clean_text</code> does indeed look cleaner.</p>
<pre class="r"><code>nobel &lt;- nobel %&gt;%
  select(Year, Laureate, clean_text) %&gt;%
  rename(Year = Year, Laureate = Laureate, AwardSpeech = clean_text)  # renaming cols
write_rds(nobel, &quot;data/nobel_cleaned.Rds&quot;)</code></pre>
<p>More information on regular expressions: - <a
href="https://www.princeton.edu/~mlovett/reference/Regular-Expressions.pdf"
class="uri">https://www.princeton.edu/~mlovett/reference/Regular-Expressions.pdf</a>
- <span class="citation">Wickham and Grolemund (2016)</span>, chapter
14. -</p>
</div>
<div id="excercises" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Excercises</h2>
<ul>
<li>Look at other excess text in the Nobel corpus. How can we write code
to cut these peices out?</li>
<li>Are the problems the same with the SR report corpus? Take a look and
see if we can run the same code or we need to do different things to
clean that corpus.</li>
</ul>
</div>
</div>
<div id="manipulating-dataframes" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Manipulating
dataframes</h1>
<p>At this point there is actually a fair amount we can do with our
corpus as a dataframe and text corpus in one column. To help us
manipulate dataframes, let’s take a quick look at the tidyverse’s system
of manipulation by common-sense verbs.</p>
<p>With <code>nobel</code> we have a dataframe of speeches from 1905 to
2019 (with some holes where there was no prize given out). How do we
subset this dataframe so we have only speeches from 1950-1980? Use
filter.</p>
<pre class="r"><code>nobel %&gt;%
  filter(Year &gt;= 1950 &amp; Year &lt;= 1980)</code></pre>
<pre><code>## # A tibble: 26 × 3
##     Year Laureate                                                    AwardSpeech
##    &lt;dbl&gt; &lt;chr&gt;                                                       &lt;chr&gt;      
##  1  1950 Ralph Bunche                                                &quot;dr. ralph…
##  2  1951 Léon Jouhaux                                                &quot;alfred no…
##  3  1952 Albert Schweitzer                                           &quot;albert sc…
##  4  1953 George C. Marshall                                          &quot;when cade…
##  5  1954 Office of the United Nations High Commissioner for Refugees &quot;the nobel…
##  6  1957 Lester Bowles Pearson                                       &quot;the nobel…
##  7  1958 Georges Pire                                                &quot;the nobel…
##  8  1959 Philip Noel-Baker                                           &quot;frequentl…
##  9  1960 Albert Lutuli                                               &quot;this year…
## 10  1961 Dag Hammarskjöld                                            &quot;the nobel…
## # … with 16 more rows
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>Here we’ve said to filter the corpus based on rows where Year is
greater or equal to 1950 and less than or equal to 1980. &amp; is the
“and” operator, | is “or”, and ! is not.</p>
<pre class="r"><code>nobel %&gt;%
  filter(Year == 1950 | Year == 1980) # returns rows for 1950 and 1980
nobel %&gt;%
  filter(Year &gt;= 1950 &amp; Year &lt;= 1954 &amp; Year != 1953) # returns rows &gt;= 1950, &lt;=1954 and not 1953</code></pre>
<p><code>mutate</code> adds new columns. Say we’d like a column telling
us whether the year was before WWII or after.</p>
<pre class="r"><code>nobel %&gt;%
  mutate(after_WWII = Year &gt; 1945)</code></pre>
<pre><code>## # A tibble: 92 × 4
##     Year Laureate                                                Award…¹ after…²
##    &lt;dbl&gt; &lt;chr&gt;                                                   &lt;chr&gt;   &lt;lgl&gt;  
##  1  1905 Bertha von Suttner                                      &quot;on be… FALSE  
##  2  1906 Theodore Roosevelt                                      &quot;as th… FALSE  
##  3  1907 Ernesto Teodoro Moneta, Louis Renault                   &quot;ernes… FALSE  
##  4  1908 Klas Pontus Arnoldson, Fredrik Bajer                    &quot;on be… FALSE  
##  5  1909 Auguste Beernaert, Paul Henri d&#39;Estournelles de Consta… &quot;augus… FALSE  
##  6  1910 Permanent International Peace Bureau                    &quot;chair… FALSE  
##  7  1911 Tobias Asser, Alfred Fried                              &quot;tobia… FALSE  
##  8  1912 Elihu Root                                              &quot;elihu… FALSE  
##  9  1913 Henri La Fontaine                                       &quot;henri… FALSE  
## 10  1922 Fridtjof Nansen                                         &quot;i tak… FALSE  
## # … with 82 more rows, and abbreviated variable names ¹​AwardSpeech, ²​after_WWII
## # ℹ Use `print(n = ...)` to see more rows</code></pre>
<p>One thing I often do is use <code>mutate</code> to do word counts of
every document row, essentially by counting all clusters of words or
numbers that are separated by spaces on either side.</p>
<pre class="r"><code>nobel &lt;- nobel %&gt;%
  mutate(wc = str_count(AwardSpeech, &#39;[\\w]+&#39;))</code></pre>
<p>And now we can finally start doing some analysis! Right now you will
note that if we want to plot the length of award speeches over time, we
have a Year column that could be an x-axis variable and a word count
column as y-axis. This sounds tidy to me.</p>
<pre class="r"><code>nobel %&gt;%
  ggplot(aes(x = Year, y = wc)) +
  geom_line() # just line graph, we might add geom_point() to underscore that we have missing years</code></pre>
<p><img src="1_2-readingcleaning_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<p>Tidy offers us the handy <code>summarize</code> command to summarize.
First, can we sum all the word counts to get a total word count for our
entire Nobel corpus? And average word count?</p>
<pre class="r"><code>nobel %&gt;%
  summarize(average = sum(wc))</code></pre>
<pre><code>## # A tibble: 1 × 1
##   average
##     &lt;int&gt;
## 1  236021</code></pre>
<pre class="r"><code>nobel %&gt;%
  summarize(average = mean(wc))</code></pre>
<pre><code>## # A tibble: 1 × 1
##   average
##     &lt;dbl&gt;
## 1   2565.</code></pre>
<p>Where summarize really shines though is if we have groups. Let’s
split our corpus up by decade and then we’ll get average word counts by
decade using the <code>group_by</code> function.</p>
<pre class="r"><code>nobel %&gt;%
  mutate(decade = (Year %/% 10) * 10) %&gt;% # uses something called modulo division to get the decade
  group_by(decade) %&gt;%
  summarize(mean(wc))</code></pre>
<pre><code>## # A tibble: 12 × 2
##    decade `mean(wc)`
##     &lt;dbl&gt;      &lt;dbl&gt;
##  1   1900       713 
##  2   1910       686.
##  3   1920      3257.
##  4   1930      2428.
##  5   1940      3417.
##  6   1950      3577.
##  7   1960      3288.
##  8   1970      3087 
##  9   1980      2948.
## 10   1990      1874.
## 11   2000      2517.
## 12   2010      2084.</code></pre>
<p><code>summarize</code> also has a <code>n()</code> function that can
be helpful telling us how many observations per group we have. There
were alot of years without a Nobel Peace Prize so this might be
interesting to look at.</p>
<pre class="r"><code>nobel %&gt;%
  mutate(decade = (Year %/% 10) * 10) %&gt;% 
  group_by(decade) %&gt;%
  summarize(n())</code></pre>
<pre><code>## # A tibble: 12 × 2
##    decade `n()`
##     &lt;dbl&gt; &lt;int&gt;
##  1   1900     5
##  2   1910     4
##  3   1920     5
##  4   1930     8
##  5   1940     5
##  6   1950     8
##  7   1960     8
##  8   1970     9
##  9   1980    10
## 10   1990    10
## 11   2000    10
## 12   2010    10</code></pre>
<p>This also gives us all the tools we need to do google-style n-gram
plots (there are many ways to do this of course). We count the number of
words in the texts, group by year, and then plot.</p>
<pre class="r"><code>nobel %&gt;%
  mutate(peace = str_count(AwardSpeech, &quot;[Pp]eace&quot;)) %&gt;%
  mutate(war = str_count(AwardSpeech, &quot;[Ww]ar&quot;)) %&gt;%
  mutate(humright = str_count(AwardSpeech, &quot;[Hh]uman [Rr]ights&quot;)) %&gt;%
  group_by(Year) %&gt;%
  summarize(peace = sum(peace), war = sum(war), human_rights = sum(humright)) %&gt;%
  pivot_longer(c(&quot;peace&quot;, &quot;war&quot;, &quot;human_rights&quot;), names_to = &quot;word&quot;, values_to = &quot;counts&quot;) %&gt;%
  ggplot(aes(x = Year, y = counts, color = word)) +
    geom_line()</code></pre>
<p><img src="1_2-readingcleaning_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div id="excercises-1" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Excercises</h2>
<ul>
<li>Make other n-grams of your choice of the Nobel corpus. Anything
surprising?</li>
<li>Using the SR corpus, find total word count of the corpus, graph word
counts by company over time, and plot out n-grams of words of your
choice.</li>
<li>Chart n-grams over time per company with the SR corpus.</li>
</ul>
</div>
</div>
<div id="appendix" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Appendix</h1>
<div id="web-scraping" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Web scraping</h2>
<p>Web scraping is a huge and often quite complicated topic that one
would rightfully want to dedicate an entire workshop, possibly much
longer than 2 days, to. Given that this is a large and rich potential
source of text for historians, we look at just the <em>very</em> basics
here.</p>
<p>Say we’d like to scrape stories from nrk.no. Let’s just pick a random
<a
href="https://www.nrk.no/sport/ol-drama-for-iuel-_-full-forvirring-i-semifinalen-1.15595722">one</a>.</p>
<div class="figure" style="text-align: center">
<img src="data/nrk.jpg" alt="Top story on nrk.no when I was preparing this presentation" width="960" />
<p class="caption">
Top story on nrk.no when I was preparing this presentation
</p>
</div>
<p>We’ll use a library called <code>rvest</code>. We’ll first call the
library, enter the url and use <code>read_html</code> to download the
data from that url.</p>
<pre class="r"><code>library(rvest)
url &lt;- &quot;https://www.nrk.no/sport/ol-drama-for-iuel-_-full-forvirring-i-semifinalen-1.15595722&quot;
nrk &lt;- read_html(url)
nrk</code></pre>
<pre><code>## {html_document}
## &lt;html class=&quot;no-js sport&quot; lang=&quot;nb-NO&quot;&gt;
## [1] &lt;head&gt;\n&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8 ...
## [2] &lt;body&gt;\n&lt;script&gt;\nvar darkmode = document.cookie.match(&#39;(^|;)\\\\s*nrkno- ...</code></pre>
<p>So we have it? Well, kind of. We have “it” but we also have a whole
lot more. There’s a lot of information on this page, much of which we
don’t need or want to collect. The menus, the other related stories, and
so on. Plus, what we get with R is not just what we see but a whole ton
of tags and definitions that are intended for our browsers, not for us.
We maybe want the text, headline, author, and the date. So how do we get
this information, no more no less?</p>
<p>We’ll need to go into the actual HTML code and find the information
and then tell R where to get it. Luckily this is a bit easier than it
sounds. In your web browser go to the menu button -&gt; More tools -&gt;
Web Developer Tools.</p>
<p>You’ll get a panel of web developer tools. On the top menu line of
the panel is an icon (circled in the image below) for selecting an
element in the page.</p>
<div class="figure" style="text-align: center">
<img src="data/nrk_tools.jpg" alt="This will look slightly different in different browsers." width="954" />
<p class="caption">
This will look slightly different in different browsers.
</p>
</div>
<p>With this selected, you now want to find the parts of the page you
want to extract. When you go to the journalists’ names and hover over
with your mouse, you will see a box above with
<code>a.author__name</code> written in it. That’s the html tag telling
the browser how to display the author’s names and that’s what we’ll tell
R to extract.</p>
<pre class="r"><code>authors &lt;- nrk %&gt;%
  html_elements(&#39;a.author__name&#39;) %&gt;%
  html_text()
authors</code></pre>
<pre><code>## [1] &quot;Hanne Skjellum&quot;       &quot;Anders Skjerdingstad&quot;</code></pre>
<p>We do the same with the thing with the headline, date and text (it
might take some experimentation to get this right).</p>
<pre class="r"><code>headline &lt;- nrk %&gt;%
  html_elements(&#39;h1.title.title-large.article-title&#39;) %&gt;%
    html_text()

text &lt;- nrk %&gt;%
  html_elements(&#39;div.lp_articlebody.text-body.text-body-sans-serif.container-widget-content.nostack.cf&#39;) %&gt;%
  html_text()
text</code></pre>
<pre><code>## [1] &quot;\n\nDet hadde akkurat begynt å regne kraftig i Tokyo da den første semifinalen på 400 meter hekk skulle gå i gang. Og Amalie Iuel fikk en svært uheldig start på det hele, da hun snublet ut av startblokkene da hun skulle teste dem like før løpet.\n– Jeg hadde satt blokka og skulle ta en prøvestart, men det var vått på banen og jeg sklei. Så jeg satte den på nytt og da gikk det greit. Jeg føler ikke det satte meg så mye ut, selv om det ikke så sånn ut, forteller Iuel til NRK.\n\n\nTRØBBEL: Amalie Iuel fikk ingen god opplevelse i semifinalen i OL og snublet i oppvarmingen.\nFoto: Lise Åserud / NTB\n\nFor så tjuvstartet hun da smellet kom, og Iuel tok seg raskt til hodet. Reaksjonstiden viste – 0,08 sekund, og hun innså feilen det med en gang.\n– Jeg var sikker på at jeg hørte noe, men jeg så med en gang da jeg rykket ut av blokka, at det ikke var skuddet. Jeg må ha hørt noe på tribunen eller noe. Det er vanskelig å bevise for starteren og dommeren, sier Iuel.\n\n\nREAKSJON: Amalie Iuel forstod raskt egen feil.\nFoto: DYLAN MARTINEZ / Reuters\n\n– På 400 og 400 meter hekk så skjer jo ikke det, for man får ingen fordel, man tjener ikke noe på det på et såpass langt løp. Jeg reagerte på et eller annet som ikke var skuddet, og det er utrolig irriterende, forklarer hun videre.\nFikk starte under protest\nHun var raskt borte hos dommeren for å forklare seg. Og den norske hekkeløperen fikk starte.\nLikevel følte hun at løpet var kjørt.\n\n\nPRAT: Amalie Iuel snakket med dommeren og fikk starte.\nFoto: Lise Åserud / NTB\n\n– Han sa jeg kunne løpe under protest, men når det har skjedd, så klarte jeg ikke å nullstille meg og glemme det. Det ble et rotete løp og mange tanker som gikk igjennom hodet på en gang der. Det var lite fokus på siste løpet. Det gikk som det gikk, alle så jo det, forklarer 27-åringen, som deltar i sitt andre OL.\nIuel endte sist i feltet, og da resultatlistene kom, stod det at hun var diskvalifisert.\n– Det er kanskje like greit at det endte med en disk, i stedet for å få det resultatet jeg fikk, sier Iuel.\nIkke disket likevel\nMen da resultatlistene ble oppdatert, stod likevel Iuel oppført med tiden 57.61, og ikke «DQ». I stedet hadde hun fått et gult kort. Amerikanske Dalilah Muhammad vant klart, med 53.30. \n– Hun fikk gult kort for å forstyrre de andre, ikke disk da de godtok at hun hørte en lyd, sier sportssjef i friidrettsforbundet, Erlend Slokvik.\nIuels uttalte mål i OL var å forbedre den personlige rekorden satt i Doha-VM, på 54.72.\n– Jeg må ærlig innrømme at jeg har hatt bedre dager. OL kommer ikke så veldig ofte, men jeg får snu det til noe positivt og si at det bare er tre år til neste gang. Men det er selvfølgelig dødskjipt. Det er ikke sånn man må avslutte et OL. Jeg må prøve ikke grave meg for langt ned.\n\n\nVÅTT: Selv om Iuel sklei før starten, følte hun ikke det var det som ødela semifinalen for henne.\nFoto: Lise Åserud / NTB\n\nFor dem som så på, var det vanskelig å skjønne hva som faktisk skjedde.\n– Vi sitter her i Oslo og forstår ganske lite, uttalte NRKs ekspert Christina Vukicevic.\n– Hun må ha fått lov til å starte selv om hun ble diskvalifisert, tippet Jann Post.\n– Jeg er litt usikker på reglene her. Det er mulig det er de ekstraordinære forholdene, sa Vebjørn Rodal, som mener Iuels forklaring på det som hendte var god.\nI morgen natt, norsk tid, løper lagkamerat Karsten Warholm finale på samme distanse.\n– Jeg må bare prøve å glemme det her, og jeg skal i hvert fall ikke dra ham med meg. Jeg må nullstille og backe Karsten. Det får bli jobben min nå, sier Iuel.\n&quot;</code></pre>
<p>The date is a little bit trickier (as is the sub-headline). First of
all, for me, looking at it the day of, the date is just “i dag”. That’s
not too helpful for posterity. But it’s not just that, it’s within a
<code>span</code> class that’s not going to recognize for various and
sundry reasons anyway (you can try it). But if we click on the date and
then look in the developer tools panel below (or on the side if its
Chrome) it will show us that this span class is itself embedded in a a
time tag (one line up from the span with the date-time) which in turn
has a date-time. When we hover over this line we now see a box over the
date with ‘time.datetime-absolute.datePublished’ written. Let’s see if
this works.</p>
<pre class="r"><code>library(lubridate)
date &lt;- nrk %&gt;%
  html_element(&#39;time.datetime-absolute.datePublished&#39;) %&gt;%
  html_text()
date</code></pre>
<pre><code>## [1] &quot;\n02.08.2021, kl. 13.42\n&quot;</code></pre>
<p>This has it, but more than we want. We have some “” which is code to
create a new line on the page. There might well be a way to fine tune
our html_element() parameters with <code>rvest</code> to get it to
extract just the information we want but we can also do this with other
R tools. We’ll use <a
href="https://stringr.tidyverse.org/"><code>stringr</code></a> (yet
another member of the tidyverse). <code>stringr</code> is a package to
search ad manipulate character strings. What we need is something that
will extract just the date from the above character string
<code>time</code>. To do this we’ll think back and remember the tutorial
on regular expressions. We’ll extract the portion of the string that
matches the DDDD-DD-DD pattern, where D are digits.</p>
<pre class="r"><code>library(stringr)

date &lt;- date %&gt;%
  str_extract(pattern = &quot;[0-9]{2}.[0-9]{2}.[0-9]{4}&quot;) %&gt;% # should be //.
  dmy()</code></pre>
<p>So we’ve now extracted all the information we want. We can put it all
together in a dataframe now.</p>
<pre class="r"><code>library(tidyverse)
(article &lt;- tibble(Author = authors, Date = date, Headline = headline, Text = text))</code></pre>
<pre><code>## # A tibble: 2 × 4
##   Author               Date       Headline                                 Text 
##   &lt;chr&gt;                &lt;date&gt;     &lt;chr&gt;                                    &lt;chr&gt;
## 1 Hanne Skjellum       2021-08-02 OL-drama for Iuel – full forvirring i s… &quot;\n\…
## 2 Anders Skjerdingstad 2021-08-02 OL-drama for Iuel – full forvirring i s… &quot;\n\…</code></pre>
<p>Note in true tidy form its creating two rows of this dataframe, two
“observations”, one for each journalist. We got this because we had two
authors and they were in a vector of two items (each name). To condense
we could concatenate them into one object.</p>
<pre class="r"><code>(authors &lt;- str_c(authors, collapse = &quot;, &quot;)) # also from stringer, concatenates multiple character objects into one</code></pre>
<pre><code>## [1] &quot;Hanne Skjellum, Anders Skjerdingstad&quot;</code></pre>
<pre class="r"><code>(article &lt;- tibble(Author = authors, Date = date, Headline = headline, Text = text))</code></pre>
<pre><code>## # A tibble: 1 × 4
##   Author                               Date       Headline                 Text 
##   &lt;chr&gt;                                &lt;date&gt;     &lt;chr&gt;                    &lt;chr&gt;
## 1 Hanne Skjellum, Anders Skjerdingstad 2021-08-02 OL-drama for Iuel – ful… &quot;\n\…</code></pre>
<div id="links-to-more-information" class="section level3"
number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Links to more
information</h3>
<p>As noted, this is just the barest of introductions. I wanted,
however, to at least go through the basics because it’s a rich source of
possible texts for historians. As of just a few years ago if you wanted
to do sophisticated web scraping you really had to turn to Python. And
Python perhaps still has the edge, particularly with a library called
BeautifulSoup.<a href="#fn1" class="footnote-ref"
id="fnref1"><sup>1</sup></a> But packages in R have come a long way in
the last couple years and you can now do pretty sophisticated scraping
in R as well. I attach a few links that will help you get started if you
are so interested.</p>
<ul>
<li><a
href="https://rvest.tidyverse.org/articles/harvesting-the-web.html"
class="uri">https://rvest.tidyverse.org/articles/harvesting-the-web.html</a></li>
<li><a
href="https://towardsdatascience.com/tidy-web-scraping-in-r-tutorial-and-resources-ac9f72b4fe47"
class="uri">https://towardsdatascience.com/tidy-web-scraping-in-r-tutorial-and-resources-ac9f72b4fe47</a></li>
<li><a
href="https://github.com/yusuzech/r-web-scraping-cheat-sheet/blob/master/README.md"
class="uri">https://github.com/yusuzech/r-web-scraping-cheat-sheet/blob/master/README.md</a></li>
<li><a href="https://www.scrapingbee.com/blog/web-scraping-r/"
class="uri">https://www.scrapingbee.com/blog/web-scraping-r/</a></li>
</ul>
</div>
</div>
<div id="more-scraping-more-advanced" class="section level2"
number="4.2">
<h2><span class="header-section-number">4.2</span> More scraping (more
advanced)</h2>
<p>Back when we were scraping stories from the NRK website, we scraped
one story. But probably what we’d really like to do is build up a
<em>corpus</em> of texts, not just one article but numerous. You could
just do the above by hand and have a tibble for every article and then
combine multiple tibbles to get one large tibble that had your whole
corpus. But there is a much better way and one that will introduce a
basic concept of programming called a “for loop”.</p>
<p>Assume we want to scrape a bunch of NRK stories. We can put the urls
in a vector in R.</p>
<pre class="r"><code>articles &lt;- c(&quot;https://www.nrk.no/sport/grovdal-fullstendig-parkert-i-ol-finalen_-_-det-er-rett-og-slett-litt-vondt-a-se-pa-1.15595563&quot;, &quot;https://www.nrk.no/sport/vant-heat-etter-fall-i-siste-runde_-_-umenneskelig-1.15595067&quot;, &quot;https://www.nrk.no/vestland/hemmelig-plan-for-statsraad-lehmkuhl_-sommerskuta-dukket-plutselig-opp-i-bergen-1.15595488&quot;, &quot;https://www.nrk.no/osloogviken/tiltalt-for-forsettlig-drap-pa-christian-halvorsen-1.15595796&quot;) # a random list of the top stories on NRK at the time of writing. Saving as character objects so remember to put the urls in quotes</code></pre>
<p>I now have a list of urls and for each item of this list I want to do
the same thing. So we will “loop” through this list doing what we just
did for the one NRK article to each of the objects of this list. Here is
the syntax.</p>
<pre class="r"><code>corpus &lt;- tibble()  # creating an empty tibble to copy everything into
for (url in articles){ # looping over our list of 4 urls
  nrk &lt;- read_html(url) 
  authors &lt;- nrk %&gt;%
    html_elements(&#39;a.author__name&#39;) %&gt;%
    html_text()
  authors &lt;- str_c(authors[[1]], collapse = &quot;, &quot;) # also from stringer, concatenates multiple character objects into one
  headline &lt;- nrk %&gt;%
    html_elements(&#39;h1.title.title-large.article-title&#39;) %&gt;%
    html_text()
  text &lt;- nrk %&gt;%
    html_elements(&#39;div.lp_articlebody.text-body.text-body-sans-serif.container-widget-content.nostack.cf&#39;) %&gt;%
    html_text()
  date &lt;- nrk %&gt;%
    html_element(&#39;time.datetime-absolute.datePublished&#39;) %&gt;%
    html_text() %&gt;%
    str_extract(pattern = &quot;[0-9]{2}.[0-9]{2}.[0-9]{2}&quot;) %&gt;%
    dmy()
  article &lt;- tibble(Author = authors, Date = date, Headline = headline, Text = text, URL = url)
  corpus &lt;- rbind(corpus, article) # rbind stands for &quot;row bind&quot;. We copy the rows of our new article dataframe to the old corpus dataframe which at the end of the for loop will give us a dataframe called corpus with all the data from our four articles
  }</code></pre>
<p>In words, we are telling R: “Hey R, I have a vector (i.e. a list)
called <code>articles</code>. I want you to go into this vector and look
at each object individually. We’re going to call these objects
<code>url</code> (note we could call them anything at all, this is just
name. Often objects in for lists are called i, sometimes x, etc.) For
each individual object in my vector, do what is written in the curly
braces (all the steps we went through to scrape one article”).</p>
</div>
<div id="scraping-the-nobel-speeches" class="section level2"
number="4.3">
<h2><span class="header-section-number">4.3</span> Scraping the nobel
speeches</h2>
<p>If we google “nobel prize ceremony speech”, we land on a page that
looks like <a
href="https://www.nobelprize.org/prizes/peace/2018/ceremony-speech/">this</a>.
We note that we can navigate to ceremony speeches of other years but
this takes a lot of clicking. It’s going to take a lot of work to
program a bot to do this. BUT! If we look at the url we see that it’s
standardized with a year. What if we try the same thing with 2017? It
gives us exactly the page we want. In fact, it does so for any year
since the very earliest years of the prize. (Incidentally, navigating by
links on the cite I have trouble accessing them before the 1960s.) This
makes it very easy to generate a list of links.</p>
<pre class="r"><code># https://www.nobelprize.org/prizes/peace/1905/ceremony-speech/   This is the link that we need to replicate changing the year for each year between 1905 and 2019. We&#39;ll start in 1905 as before that it&#39;s not really the speech but something less, we want to compare apples to apples as much as possible
library(rvest)
## https://www.nobelprize.org/prizes/peace/1905/ceremony-speech/
urls &lt;- vector()
for (i in 1905:2019){
  new_url &lt;- paste0(&quot;https://www.nobelprize.org/prizes/peace/&quot;, i, &quot;/ceremony-speech/&quot;)
  urls &lt;- append(urls, new_url)
  }</code></pre>
<p>But not all these links exist because the Nobel wasn’t given out in
all years. If we try to open those years (try, for instance, <a
href="https://www.nobelprize.org/prizes/peace/1915/ceremony-speech/"
class="uri">https://www.nobelprize.org/prizes/peace/1915/ceremony-speech/</a>)
There are several ways we could deal with this, we could write down
years it wasn’t given out and remove them from our list of possible
urls. But the other thing we can do is use a “try block” within our loop
that tells R precisely that: try this, but if it doesn’t work, just got
on to the next object in the loop. We’re going to do this, and then
scrape the page in a similar way to which we scraped nrk.no in the last
unit. We’re going to be a bit more particular about what we edit out
because we want only the the text of the speeches as much as possible,
not the additional information (citation info, informational footers,
etc) that the site gives us.</p>
<pre class="r"><code>corp &lt;- tibble()
for (url_address in urls){
  try(
  {
    nobel &lt;- read_html(url_address)
    text &lt;- nobel %&gt;%
      html_elements(&#39;article.page-content.border-top.entry-content&#39;) %&gt;%
      html_elements(&#39;p&#39;) %&gt;%
      html_text() %&gt;%
      tibble()
    footer &lt;- nobel %&gt;%
      html_elements(&quot;footer&quot;) %&gt;%
      html_elements(&#39;p&#39;) %&gt;%
      html_text() %&gt;%
      tibble()
    small_text &lt;- nobel %&gt;%
      html_elements(&quot;p.smalltext&quot;) %&gt;%
      html_text() %&gt;%
      tibble() %&gt;%
      drop_na()
    copy_text &lt;- nobel %&gt;%
      html_elements(&quot;p.copy&quot;) %&gt;%
      html_text() %&gt;%
      tibble() %&gt;%
      drop_na()
    remove_text &lt;- rbind(footer, small_text, copy_text)
    remove &lt;- vector()
    for (i in 1:dim(remove_text)[1]){
      for (j in 1:dim(text)[1]){
        if (text[j,] == remove_text[i,]){
        remove &lt;- c(remove, j)
      }
    }
    }
    text &lt;- text[-remove, ]
    total_text &lt;- &#39;&#39;
      for (i in 1:dim(text)[1]) {
        total_text &lt;- paste(total_text, str_c(text[i,1]))
        }
    laureate &lt;- nobel %&gt;%
      html_elements(&#39;li.list-laureate&#39;) %&gt;%
      html_text() %&gt;%
      str_trim() # trims white space before and after
    laureate &lt;- str_c(laureate, collapse = &quot;, &quot;) # also from stringer, concatenates multiple character objects into one
    year &lt;- str_extract(url_address, &quot;[0-9]{4}&quot;)
    temp_tibble &lt;- tibble(Year = year, Laureate = laureate, AwardSpeech = total_text)
    temp_tibble
    corp &lt;- rbind(corp, temp_tibble)
}
  )
}

write.csv(corp, &quot;NobelPeace.csv&quot;)</code></pre>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-mitchell2018web" class="csl-entry">
Mitchell, Ryan. 2018. <em>Web Scraping with Python: Collecting More Data
from the Modern Web</em>. " O’Reilly Media, Inc.".
</div>
<div id="ref-wickham2016r" class="csl-entry">
Wickham, Hadley, and Garrett Grolemund. 2016. <em><span>R</span> for
Data Science: Import, Tidy, Transform, Visualize, and Model Data</em>. "
O’Reilly Media, Inc.". <a
href="https://r4ds.had.co.nz/index.html">https://r4ds.had.co.nz/index.html</a>.
</div>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>A good, thorough introduction for those interested is
<span class="citation">Mitchell (2018)</span>.<a href="#fnref1"
class="footnote-back">↩︎</a></p></li>
</ol>
</div>

<br><br><p>2022.


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
